/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model centered
 * around the "Farmer" entity. All data related to a farmer, such as their farms,
 * forecasts, and reports, is nested under a path dedicated to that user. This
 * approach ensures data privacy and simplifies security logic by leveraging path-based
 * authorization.
 *
 * Data Structure: The primary data hierarchy is `/farmers/{farmerId}/...`. This
 * structure ensures that all user-specific data is isolated within their own
 * data tree. A separate top-level collection, `/crops`, holds publicly readable,
 * global data that is not tied to any specific user.
 *
 * Key Security Decisions:
 * - Default Deny: All operations are denied unless explicitly allowed.
 * - User Isolation: A user can only access data within their own
 *   `/farmers/{userId}` path.
 * - No User Enumeration: Listing documents in the top-level `/farmers` collection
 *   is strictly forbidden to protect user privacy.
 * - Read-Only Global Data: The `/crops` collection is readable by any authenticated
 *   user but is not writable from the client-side, ensuring data integrity. It must
 *   be managed by a trusted backend process.
 *
 * Denormalization for Authorization: To maintain simple and performant rules,
 * ownership is determined by the `farmerId` in the document path. Sub-collections like
 * `/farms` contain a `farmerId` field within their data to enforce relational

 * integrity on creation and prevent re-parenting on update. This avoids costly `get()`
 * calls to parent documents.
 *
 * Structural Segregation: Private user data (e.g., farms, profit predictions) is
 * structurally separated from public data (`/crops`). This is a secure and performant
 * pattern for managing different access levels, especially for list operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * For update/delete, checks ownership AND that the document already exists.
     * This prevents modifying or deleting a document that doesn't exist.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * On create, validates that a Farmer's own profile document contains an `id`
     * field that matches their auth UID. This enforces relational integrity.
     */
    function isCreatingFarmerProfile(farmerId) {
      return isOwner(farmerId) && request.resource.data.id == farmerId;
    }

    /**
     * On update, ensures the farmer's unique `id` cannot be changed.
     */
    function isUpdatingFarmerProfile() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * On create, validates that a sub-document (like a Farm) has its `farmerId`
     * field correctly set to the owner's UID from the path.
     */
    function isCreatingFarmForSelf(farmerId) {
      return isOwner(farmerId) && request.resource.data.farmerId == farmerId;
    }

    /**
     * On update, ensures the `farmerId` foreign key cannot be changed, preventing
     * a document from being moved between owners.
     */
    function farmerIdIsImmutable() {
      return request.resource.data.farmerId == resource.data.farmerId;
    }


    /**
     * @description Manages user profile documents.
     * @path /users/{userId}
     * @allow A user can create, read, and update their own profile.
     * @deny Users cannot delete their profiles or access others' profiles.
     */
    match /users/{userId} {
      allow read, update: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow delete: if false;
      allow list: if false;
    }

    /**
     * @description Manages farmer profile documents. Each farmer can create their own profile, but cannot see or list others.
     * @path /farmers/{farmerId}
     * @allow A user (UID 'user123') creating their own document at `/farmers/user123`. (create)
     * @deny An anonymous user trying to read `/farmers/user123`. (get)
     * @deny A logged-in user ('user456') trying to list all documents at `/farmers`. (list)
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /farmers/{farmerId} {
      allow get: if isOwner(farmerId);
      allow list: if false;
      allow create: if isCreatingFarmerProfile(farmerId);
      allow update: if isExistingOwner(farmerId) && isUpdatingFarmerProfile();
      allow delete: if isExistingOwner(farmerId);
    }

    /**
     * @description Manages the farms owned by a specific farmer. Only the farmer can manage their own farms.
     * @path /farmers/{farmerId}/farms/{farmId}
     * @allow The farmer 'user123' creating a new farm document in their own subcollection `/farmers/user123/farms/farm_abc`. (create)
     * @deny A different farmer 'user456' trying to update a farm at `/farmers/user123/farms/farm_abc`. (update)
     * @principle Enforces document ownership for all operations within a user-specific subcollection.
     */
    match /farmers/{farmerId}/farms/{farmId} {
      allow get: if isOwner(farmerId);
      allow list: if isOwner(farmerId);
      allow create: if isCreatingFarmForSelf(farmerId);
      allow update: if isExistingOwner(farmerId) && farmerIdIsImmutable();
      allow delete: if isExistingOwner(farmerId);
    }

    /**
     * @description Manages globally available crop information. This data is public to all authenticated users but cannot be modified by them.
     * @path /crops/{cropId}
     * @allow Any authenticated user reading the document at `/crops/wheat`. (get)
     * @deny Any user, authenticated or not, trying to create a new crop document. (create)
     * @principle Provides public, read-only access to a global dataset, with writes restricted to trusted server environments.
     */
    match /crops/{cropId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures climate risk forecasts, which are private to the farm's owner.
     * @path /farmers/{farmerId}/farms/{farmId}/climateRiskForecasts/{climateRiskForecastId}
     * @allow The farmer 'user123' reading a forecast at `/farmers/user123/farms/farm_abc/climateRiskForecasts/forecast_1`. (get)
     * @deny Another farmer 'user456' trying to delete that same forecast. (delete)
     * @principle Enforces strict ownership based on the top-level `farmerId` in the path for nested subcollections.
     */
    match /farmers/{farmerId}/farms/{farmId}/climateRiskForecasts/{climateRiskForecastId} {
      allow get: if isOwner(farmerId);
      allow list: if isOwner(farmerId);
      allow create: if isOwner(farmerId);
      allow update: if isExistingOwner(farmerId);
      allow delete: if isExistingOwner(farmerId);
    }

    /**
     * @description Secures profit predictions, which are private to the farm's owner.
     * @path /farmers/{farmerId}/farms/{farmId}/profitPredictions/{profitPredictionId}
     * @allow The farmer 'user123' listing all predictions for their farm at `/farmers/user123/farms/farm_abc/profitPredictions`. (list)
     * @deny An anonymous user attempting to create a prediction. (create)
     * @principle Enforces strict ownership based on the top-level `farmerId` in the path for nested subcollections.
     */
    match /farmers/{farmerId}/farms/{farmId}/profitPredictions/{profitPredictionId} {
      allow get: if isOwner(farmerId);
      allow list: if isOwner(farmerId);
      allow create: if isOwner(farmerId);
      allow update: if isExistingOwner(farmerId);
      allow delete: if isExistingOwner(farmerId);
    }

    /**
     * @description Secures harvest batch data (digital passport), which is private to the farm's owner.
     * @path /farmers/{farmerId}/farms/{farmId}/harvestBatches/{harvestBatchId}
     * @allow The farmer 'user123' creating a harvest batch for their farm. (create)
     * @deny Another farmer 'user456' attempting to read a harvest batch owned by 'user123'. (get)
     * @principle Enforces strict ownership based on the top-level `farmerId` in the path for nested subcollections.
     */
    match /farmers/{farmerId}/farms/{farmId}/harvestBatches/{harvestBatchId} {
      allow get: if isOwner(farmerId);
      allow list: if isOwner(farmerId);
      allow create: if isOwner(farmerId);
      allow update: if isExistingOwner(farmerId);
      allow delete: if isExistingOwner(farmerId);
    }

    /**
     * @description Secures marketplace deals, which are private to the farm's owner.
     * @path /farmers/{farmerId}/farms/{farmId}/marketplaceDeals/{marketplaceDealId}
     * @allow The farmer 'user123' updating a deal related to their farm. (update)
     * @deny Another farmer 'user456' attempting to list deals for a farm owned by 'user123'. (list)
     * @principle Enforces strict ownership based on the top-level `farmerId` in the path for nested subcollections.
     */
    match /farmers/{farmerId}/farms/{farmId}/marketplaceDeals/{marketplaceDealId} {
      allow get: if isOwner(farmerId);
      allow list: if isOwner(farmerId);
      allow create: if isOwner(farmerId);
      allow update: if isExistingOwner(farmerId);
      allow delete: if isExistingOwner(farmerId);
    }

    /**
     * @description Secures real-time data reports, which are private to the farm's owner.
     * @path /farmers/{farmerId}/farms/{farmId}/realTimeDataReports/{realTimeDataReportId}
     * @allow The farmer 'user123' reading a real-time report from their farm. (get)
     * @deny Another farmer 'user456' attempting to create a report in a farm not belonging to them. (create)
     * @principle Enforces strict ownership based on the top-level `farmerId` in the path for nested subcollections.
     */
    match /farmers/{farmerId}/farms/{farmId}/realTimeDataReports/{realTimeDataReportId} {
      allow get: if isOwner(farmerId);
      allow list: if isOwner(farmerId);
      allow create: if isOwner(farmerId);
      allow update: if isExistingOwner(farmerId);
      allow delete: if isExistingOwner(farmerId);
    }

    /**
     * @description Manages user-generated reports. Users can create reports and can only read their own.
     * @path /reports/{reportId}
     * @allow A user creating a new report document where `userId` in the document matches their auth UID. (create)
     * @allow A user reading a report where the `userId` field matches their auth UID. (get)
     * @deny A user trying to list all reports in the collection. (list)
     * @principle User-owned data model where ownership is determined by a `userId` field in the document.
     */
    match /reports/{reportId} {
      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow list: if isSignedIn(); // Allow list for queries with `where('userId', '==', request.auth.uid)`
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false; // Reports are immutable
      allow delete: if false; // Reports are not deletable by clients
    }
  }
}

    