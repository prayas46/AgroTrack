
'use client';

import Image from "next/image";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
} from "@/components/ui/card";
import {
  Alert,
  AlertDescription,
  AlertTitle,
} from "@/components/ui/alert";
import { Button } from "@/components/ui/button";
import { Biohazard, Bug, Droplets, Download, Map, Wind, Siren } from "lucide-react";
import type { ClimateRiskForecastOutput } from "@/ai/flows/climate-risk-forecast";
import { WeatherAlerts } from "./weather-alerts";
import { PlaceHolderImages } from "@/lib/placeholder-images";
import { useToast } from "@/hooks/use-toast";
import { useFirebase } from "@/firebase";
import { createReport, type CreateReportData } from "@/lib/reports";

const riskItems = [
    { key: "pestAttackProbability", title: "Pest Attack Probability", icon: Bug },
    { key: "cropDiseaseOutbreak", title: "Crop Disease Outbreak", icon: Biohazard },
    { key: "waterShortageRisk", title: "Water Shortage Risk", icon: Droplets },
    { key: "extremeWeatherRisk", title: "Extreme Weather Risk", icon: Wind },
] as const;

export function ClimateRiskResults({ data }: { data: ClimateRiskForecastOutput }) {
    const riskMapImage = PlaceHolderImages.find(img => img.id === 'risk-map');
    const { toast } = useToast();
    const { firestore, user } = useFirebase();

    const generateReportContent = () => {
        let report = `
AGROCAST - CLIMATE RISK FORECAST REPORT
========================================
Date: ${new Date().toLocaleDateString()}
Time: ${new Date().toLocaleTimeString()}

FORECAST SUMMARY:
-----------------
This report details the climate-related risks for the selected region.

RISK ANALYSIS:
--------------
- Pest Attack Probability: ${data.pestAttackProbability}
- Crop Disease Outbreak Risk: ${data.cropDiseaseOutbreak}
- Water Shortage Risk: ${data.waterShortageRisk}
- Extreme Weather Risk: ${data.extremeWeatherRisk}

RISK MAP ANALYSIS:
------------------
${data.riskMapAnalysis}
`;

        if (data.weatherAlerts && data.weatherAlerts.length > 0) {
            report += `

ACTIVE WEATHER ALERTS:
----------------------
`;
            data.weatherAlerts.forEach((alert, index) => {
                report += `
Alert ${index + 1}: ${alert.alertTitle}
- Severity: ${alert.severity}
- Certainty: ${alert.certainty}
- Urgency: ${alert.urgency}
- Description: ${alert.description}
- Instruction: ${alert.instruction}
`;
            });
        }

        report += `

GENERATED BY: AgroCast AI System
Â© 2024 AgroCast - Smart Agriculture Management System
`;
        return report;
    };

    const handleDownloadReport = async () => {
        toast({
            title: "Generating Report...",
            description: "Your climate risk report is being prepared for download.",
        });

        const reportTitle = `Climate Risk Report - ${new Date().toISOString().split('T')[0]}`;
        
        try {
            if (firestore && user) {
                const reportData: CreateReportData = {
                    title: reportTitle,
                    type: 'Climate Risk',
                    content: data,
                };
                await createReport(firestore, user.uid, reportData);
            }

            const reportContent = generateReportContent();
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AgroCast_Climate_Report_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            toast({
                title: "Report Downloaded & Saved",
                description: "The report has been saved to your device and logged in your dashboard.",
            });

        } catch (error) {
             toast({
                variant: "destructive",
                title: "Failed to Save Report",
                description: "There was an error saving your report to the dashboard.",
            });
            console.error("Failed to create report:", error);
        }
    };

  return (
    <div className="space-y-8">
        <div className="flex flex-col sm:flex-row justify-between sm:items-center gap-4">
            <h2 className="text-2xl font-bold tracking-tight font-headline">Forecast Results</h2>
            <Button onClick={handleDownloadReport}>
                <Download className="mr-2 h-4 w-4" />
                Download & Save Report
            </Button>
        </div>


        {data.weatherAlerts && data.weatherAlerts.length > 0 && (
          <Card>
              <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                      <Siren className="h-6 w-6 text-destructive" />
                      Active Weather Alerts
                  </CardTitle>
                  <CardDescription>Immediate weather warnings for your region.</CardDescription>
              </CardHeader>
              <CardContent>
                  <WeatherAlerts alerts={data.weatherAlerts} />
              </CardContent>
          </Card>
        )}

        <div className="grid gap-6 md:grid-cols-2">
            {riskItems.map(item => (
                <Card key={item.key}>
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-sm font-medium">{item.title}</CardTitle>
                        <item.icon className="h-5 w-5 text-muted-foreground" />
                    </CardHeader>
                    <CardContent>
                        <p className="text-foreground">{data[item.key]}</p>
                    </CardContent>
                </Card>
            ))}
        </div>

        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2">
                    <Map className="h-6 w-6 text-primary" />
                    Risk Map
                </CardTitle>
                <CardDescription>Visual overview of high-risk zones in the specified region.</CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
                 {data.riskMapDataUri ? (
                    <div className="relative h-64 md:h-96 w-full overflow-hidden rounded-lg border">
                        <Image
                        src={data.riskMapDataUri}
                        alt="AI-generated risk map"
                        fill
                        className="object-cover"
                        />
                         <div className="absolute inset-0 bg-black/10 " />
                    </div>
                ) : riskMapImage && (
                    <div className="relative h-64 md:h-96 w-full overflow-hidden rounded-lg border">
                        <Image
                        src={riskMapImage.imageUrl}
                        alt={riskMapImage.description}
                        fill
                        className="object-cover"
                        data-ai-hint={riskMapImage.imageHint}
                        />
                         <div className="absolute inset-0 bg-black/10 " />
                    </div>
                )}
                 <Alert>
                    <AlertTitle>Map Analysis</AlertTitle>
                    <AlertDescription>
                        {data.riskMapAnalysis}
                    </AlertDescription>
                </Alert>
            </CardContent>
        </Card>
    </div>
  );
}
